# MCP (Model Context Protocol) æ•´åˆåŠŸèƒ½

## åŠŸèƒ½æ¦‚è¿°

æœ¬å°ˆæ¡ˆå·²æˆåŠŸæ•´åˆ MCP (Model Context Protocol) Server åŠŸèƒ½ï¼Œä½¿ç”¨ Server-Sent Events (SSE) å”è­°èˆ‡æŒ‡å®šçš„ MCP Server é€²è¡Œé€šè¨Šï¼Œç‚º LINE Bot æä¾›å¢å¼·çš„ä¸Šä¸‹æ–‡æ„ŸçŸ¥èƒ½åŠ›ã€‚

## ğŸ¯ ä¸»è¦åŠŸèƒ½

### 1. MCP æœå‹™æ¨¡çµ„ (`src/services/mcp.ts`)
- **SSE é€£æ¥ç®¡ç†**: å»ºç«‹å’Œç¶­è­·èˆ‡ MCP Server çš„ SSE é€£æ¥
- **æœƒè©±ç®¡ç†**: è‡ªå‹•è™•ç† sessionId å’Œç«¯é»è³‡è¨Š
- **éŒ¯èª¤è™•ç†**: å®Œæ•´çš„éŒ¯èª¤è™•ç†å’Œé‡è©¦æ©Ÿåˆ¶
- **çµ±è¨ˆè¿½è¹¤**: é€£æ¥çµ±è¨ˆå’Œæ•ˆèƒ½ç›£æ§

### 2. AI æœå‹™æ•´åˆ (`src/services/ai.ts`)
- **ä¸Šä¸‹æ–‡å¢å¼·**: è‡ªå‹•å¾ MCP Server ç²å–ç›¸é—œä¸Šä¸‹æ–‡
- **æ™ºèƒ½æç¤ºè©**: å°‡ MCP ä¸Šä¸‹æ–‡æ•´åˆåˆ° AI æç¤ºè©ä¸­
- **ç„¡ç¸«æ•´åˆ**: ä¸å½±éŸ¿ç¾æœ‰ AI å°è©±æµç¨‹çš„å‰æä¸‹å¢å¼·åŠŸèƒ½

### 3. ç®¡ç†å¾Œå°ç›£æ§ (`/admin/mcp.html`)
- **é€£æ¥ç‹€æ…‹ç›£æ§**: å³æ™‚é¡¯ç¤º MCP é€£æ¥ç‹€æ…‹
- **çµ±è¨ˆè³‡è¨Š**: é€£æ¥æ•¸ã€è¨Šæ¯æ•¸ã€éŒ¯èª¤æ•¸ç­‰çµ±è¨ˆ
- **æ‰‹å‹•æ§åˆ¶**: é€£æ¥ã€æ–·é–‹ã€æ¸¬è©¦åŠŸèƒ½
- **è©³ç´°è³‡è¨Š**: æœƒè©±è³‡è¨Šã€éŒ¯èª¤æ—¥èªŒã€æ¸¬è©¦çµæœ

## ğŸ”§ æŠ€è¡“å¯¦ç¾

### MCP Server ç«¯é»
```
https://kjsgmiyoejvu.ap-northeast-1.clawcloudrun.com/sse
```

### æ ¸å¿ƒé¡åˆ¥å’Œæ–¹æ³•

#### MCPService é¡
```typescript
class MCPService {
  async connect(): Promise<MCPSession>
  async sendRequest(request: MCPRequest): Promise<MCPResponse>
  async getContext(query: string): Promise<MCPContext[]>
  disconnect(): void
  getConnectionStatus(): MCPConnectionStatus
  getStats(): MCPStats
}
```

#### AIService æ•´åˆ
```typescript
class AIService {
  async generateResponse(userMessage, history, settings): Promise<string>
  getMCPConnectionStatus(): MCPConnectionStatus
  getMCPStats(): MCPStats
  async connectToMCP(): Promise<boolean>
  disconnectMCP(): void
  async testMCP(query): Promise<TestResult>
}
```

### API ç«¯é»

#### ç®¡ç† API
- `GET /admin/mcp/status` - ç²å– MCP é€£æ¥ç‹€æ…‹å’Œçµ±è¨ˆ
- `POST /admin/mcp/connect` - æ‰‹å‹•é€£æ¥ MCP Server
- `POST /admin/mcp/disconnect` - æ–·é–‹ MCP é€£æ¥
- `POST /admin/mcp/test` - æ¸¬è©¦ MCP åŠŸèƒ½

#### æ¸¬è©¦ API
- `POST /test/mcp` - æ¸¬è©¦ MCP åŸºæœ¬åŠŸèƒ½
- `POST /test/mcp-ai` - æ¸¬è©¦ MCP æ•´åˆçš„ AI å›æ‡‰

## ğŸš€ ä½¿ç”¨æ–¹å¼

### 1. è‡ªå‹•æ•´åˆ
MCP åŠŸèƒ½æœƒåœ¨ AI ç”Ÿæˆå›æ‡‰æ™‚è‡ªå‹•å•Ÿç”¨ï¼š
1. ç”¨æˆ¶ç™¼é€è¨Šæ¯åˆ° LINE Bot
2. ç³»çµ±è‡ªå‹•é€£æ¥åˆ° MCP Server
3. æ ¹æ“šç”¨æˆ¶è¨Šæ¯ç²å–ç›¸é—œä¸Šä¸‹æ–‡
4. å°‡ä¸Šä¸‹æ–‡æ•´åˆåˆ° AI æç¤ºè©ä¸­
5. ç”Ÿæˆå¢å¼·çš„ AI å›æ‡‰

### 2. ç®¡ç†å¾Œå°ç›£æ§
1. è¨ªå• `/admin/mcp.html`
2. æŸ¥çœ‹é€£æ¥ç‹€æ…‹å’Œçµ±è¨ˆè³‡è¨Š
3. æ‰‹å‹•æ§åˆ¶é€£æ¥å’Œæ¸¬è©¦åŠŸèƒ½
4. ç›£æ§ç³»çµ±é‹è¡Œç‹€æ³

### 3. æ¸¬è©¦åŠŸèƒ½
```bash
# æ¸¬è©¦ MCP åŸºæœ¬åŠŸèƒ½
curl -X POST https://your-worker.workers.dev/test/mcp \
  -H "Content-Type: application/json" \
  -d '{"query":"test query"}'

# æ¸¬è©¦ MCP æ•´åˆçš„ AI å›æ‡‰
curl -X POST https://your-worker.workers.dev/test/mcp-ai \
  -H "Content-Type: application/json" \
  -d '{"message":"æ¸¬è©¦ MCP æ•´åˆåŠŸèƒ½"}'
```

## ğŸ“Š å‹åˆ¥å®šç¾©

### æ ¸å¿ƒå‹åˆ¥ (`src/types/mcp.ts`)
- `MCPSession` - MCP æœƒè©±è³‡è¨Š
- `MCPConnectionStatus` - é€£æ¥ç‹€æ…‹
- `MCPContext` - ä¸Šä¸‹æ–‡è³‡è¨Š
- `MCPRequest/MCPResponse` - è«‹æ±‚/å›æ‡‰æ ¼å¼
- `MCPStats` - çµ±è¨ˆè³‡è¨Š

### é…ç½®é¸é …
```typescript
interface MCPServiceConfig {
  serverUrl: string;
  timeout: number;
  retryAttempts: number;
  retryDelay: number;
  enableLogging: boolean;
}
```

## ğŸ”’ å®‰å…¨è€ƒé‡

1. **é€£æ¥å®‰å…¨**: ä½¿ç”¨ HTTPS é€£æ¥åˆ° MCP Server
2. **èªè­‰æ§åˆ¶**: ç®¡ç†å¾Œå°éœ€è¦ç®¡ç†å“¡èªè­‰
3. **éŒ¯èª¤éš”é›¢**: MCP éŒ¯èª¤ä¸æœƒå½±éŸ¿ä¸»è¦ Bot åŠŸèƒ½
4. **è³‡æºç®¡ç†**: è‡ªå‹•æ–·é–‹é–’ç½®é€£æ¥ï¼Œé¿å…è³‡æºæ´©æ¼

## âš¡ æ•ˆèƒ½æœ€ä½³åŒ–

1. **ç•°æ­¥è™•ç†**: MCP è«‹æ±‚ä¸é˜»å¡ä¸»è¦å°è©±æµç¨‹
2. **é€£æ¥å¾©ç”¨**: é‡è¤‡ä½¿ç”¨ç¾æœ‰é€£æ¥ï¼Œæ¸›å°‘å»ºç«‹æˆæœ¬
3. **è¶…æ™‚æ§åˆ¶**: è¨­å®šåˆç†çš„è¶…æ™‚æ™‚é–“ï¼Œé¿å…é•·æ™‚é–“ç­‰å¾…
4. **éŒ¯èª¤æ¢å¾©**: è‡ªå‹•é‡è©¦æ©Ÿåˆ¶ï¼Œæé«˜å¯é æ€§

## ğŸ› æ•…éšœæ’é™¤

### å¸¸è¦‹å•é¡Œ
1. **é€£æ¥å¤±æ•—**: æª¢æŸ¥ MCP Server ç«¯é»æ˜¯å¦å¯è¨ªå•
2. **è¶…æ™‚éŒ¯èª¤**: èª¿æ•´ timeout è¨­å®š
3. **èªè­‰å¤±æ•—**: ç¢ºèªç®¡ç†å“¡ token æœ‰æ•ˆ
4. **ä¸Šä¸‹æ–‡ç‚ºç©º**: æª¢æŸ¥æŸ¥è©¢åƒæ•¸å’Œ MCP Server å›æ‡‰

### èª¿è©¦æ–¹æ³•
1. æŸ¥çœ‹ç€è¦½å™¨é–‹ç™¼è€…å·¥å…·çš„ Console
2. ä½¿ç”¨ç®¡ç†å¾Œå°çš„æ¸¬è©¦åŠŸèƒ½
3. æª¢æŸ¥ Cloudflare Workers æ—¥èªŒ
4. ä½¿ç”¨æ¸¬è©¦ API ç«¯é»é©—è­‰åŠŸèƒ½

## ğŸ”® æœªä¾†æ“´å±•

### å¯èƒ½çš„åŠŸèƒ½å¢å¼·
1. **å¤š MCP Server æ”¯æ´**: é€£æ¥å¤šå€‹ MCP Server
2. **å¿«å–æ©Ÿåˆ¶**: å¿«å–å¸¸ç”¨çš„ä¸Šä¸‹æ–‡è³‡è¨Š
3. **æ™ºèƒ½è·¯ç”±**: æ ¹æ“šæŸ¥è©¢é¡å‹é¸æ“‡æœ€é©åˆçš„ MCP Server
4. **æ‰¹æ¬¡è™•ç†**: æ‰¹æ¬¡è™•ç†å¤šå€‹ä¸Šä¸‹æ–‡è«‹æ±‚
5. **å³æ™‚é€šçŸ¥**: MCP Server ç‹€æ…‹è®Šæ›´é€šçŸ¥

### æ•´åˆå¯èƒ½æ€§
1. **Webhook æ•´åˆ**: æ¥æ”¶ MCP Server çš„ Webhook é€šçŸ¥
2. **è³‡æ–™åº«å„²å­˜**: å„²å­˜å¸¸ç”¨çš„ä¸Šä¸‹æ–‡è³‡è¨Š
3. **åˆ†æåŠŸèƒ½**: åˆ†æ MCP ä½¿ç”¨æ¨¡å¼å’Œæ•ˆæœ
4. **è‡ªå‹•èª¿å„ª**: æ ¹æ“šä½¿ç”¨æƒ…æ³è‡ªå‹•èª¿æ•´åƒæ•¸

## ğŸ“ˆ ç›£æ§æŒ‡æ¨™

### é—œéµæŒ‡æ¨™
- é€£æ¥æˆåŠŸç‡
- å¹³å‡å›æ‡‰æ™‚é–“
- éŒ¯èª¤ç‡
- ä¸Šä¸‹æ–‡ç²å–æˆåŠŸç‡
- æœƒè©±æŒçºŒæ™‚é–“

### å‘Šè­¦æ¢ä»¶
- é€£æ¥å¤±æ•—ç‡ > 10%
- å¹³å‡å›æ‡‰æ™‚é–“ > 5 ç§’
- éŒ¯èª¤ç‡ > 5%
- é€£çºŒ 3 æ¬¡é€£æ¥å¤±æ•—

## ğŸ‰ ç¸½çµ

MCP æ•´åˆåŠŸèƒ½ç‚º LINE Bot æä¾›äº†å¼·å¤§çš„ä¸Šä¸‹æ–‡æ„ŸçŸ¥èƒ½åŠ›ï¼Œé€šéèˆ‡å¤–éƒ¨ MCP Server çš„æ•´åˆï¼ŒBot å¯ä»¥ç²å–æ›´è±å¯Œçš„è³‡è¨Šä¾†ç”Ÿæˆæ›´æº–ç¢ºå’Œæœ‰ç”¨çš„å›æ‡‰ã€‚

**ä¸»è¦å„ªå‹¢**:
- âœ… ç„¡ç¸«æ•´åˆï¼Œä¸å½±éŸ¿ç¾æœ‰åŠŸèƒ½
- âœ… å®Œæ•´çš„ç›£æ§å’Œç®¡ç†ç•Œé¢
- âœ… å¼·å¤§çš„éŒ¯èª¤è™•ç†å’Œæ¢å¾©æ©Ÿåˆ¶
- âœ… é«˜æ•ˆçš„ SSE é€šè¨Šå”è­°
- âœ… éˆæ´»çš„é…ç½®å’Œæ“´å±•æ€§

é€™å€‹æ•´åˆç‚º LINE Bot é–‹å•Ÿäº†æ›´å¤šå¯èƒ½æ€§ï¼Œä½¿å…¶èƒ½å¤ æä¾›æ›´æ™ºèƒ½å’Œä¸Šä¸‹æ–‡ç›¸é—œçš„æœå‹™ã€‚
